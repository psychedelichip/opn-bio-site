---
import Layout from '@/layouts/layout.astro';
import { Profile } from '@/components/profile';

import { ResolveSourceService } from '@/services/resolve-source.service';
import { GetCachedSource } from '@/usecases/get-cached-source.usecase';
import { IncrementOrCreateVisit } from '@/usecases/increment-or-create-visit.usecase';
import { MarkProfileInactive } from '@/usecases/mark-profile-inactive.usecase';
import { CacheSource } from '@/usecases/cache-source.usecase';
import { FetchSource } from '@/usecases/fetch-source.usecase';
import { ProfileDrizzleRepo } from '@/infrastructure/profile-drizzzle.repository';
import { SourceRedisRepo } from '@/infrastructure/source-redis.repository';

const username = Astro.params.username?.toLowerCase();

if (!username) {
  return Astro.rewrite('/404');
}

const profileDrizzleRepo = new ProfileDrizzleRepo();
const sourceRedisRepo = new SourceRedisRepo();

const getCachedSource = new GetCachedSource(sourceRedisRepo);
const incrementOrCreateVisit = new IncrementOrCreateVisit(profileDrizzleRepo);
const markProfileInactive = new MarkProfileInactive(profileDrizzleRepo);
const cacheSource = new CacheSource(sourceRedisRepo);
const fetchSource = new FetchSource();

const resolveSource = new ResolveSourceService(
  getCachedSource,
  incrementOrCreateVisit,
  markProfileInactive,
  cacheSource,
  fetchSource,
);

const source = await resolveSource.execute(username);

if (!source) {
  return Astro.rewrite('/404');
}
---

<Layout title="Profile">
  <Profile client:load source={source} username={username} />
</Layout>
